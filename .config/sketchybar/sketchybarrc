# ------- Basic Config ----------
sketchybar --bar color=0x55282a36
sketchybar --bar position=bottom
sketchybar --bar height=26
sketchybar --bar blur_radius=100
sketchybar --bar shadow=on
sketchybar --bar margin=28
sketchybar --bar y_offset=5
sketchybar --bar corner_radius=20
sketchybar -m --add event yabai_window

# ------- Time ----------
sketchybar --add item time right
sketchybar --set time label.font="FiraCode Nerd Font Mono:Medium:12.0"
sketchybar --set time script='sketchybar --set time label="$(date "+%I:%M%p")"'
sketchybar --set time label.padding_left=20
sketchybar --set time update_freq=2

# ------- Date ----------
sketchybar --add item date right
sketchybar --set date label.font="FiraCode Nerd Font Mono:Medium:12.0"
sketchybar --set date script='sketchybar --set date label="$(date "+%m/%d/%y (%a)")"'
sketchybar --set date update_freq=4

# ------- Window Title ----------
TITLE_SCRIPT='
WINDOW_TITLE=$(/usr/local/bin/yabai -m query --windows --window | jq -r ".title")
LENGTH=100
if [[ ${#WINDOW_TITLE} -gt $LENGTH ]]; then
  WINDOW_TITLE=$(echo "$WINDOW_TITLE" | cut -c 1-$LENGTH)
  sketchybar -m --set window label="$WINDOW_TITLE"…
  exit 0
fi

APP_TITLE=$(/usr/local/bin/yabai -m query --windows --window | jq -r ".app")
if [[ $WINDOW_TITLE = "" ]]; then
    if [[ $APP_TITLE = "" ]]; then
        TITLE=""
    else
        TITLE="${APP_TITLE}"
    fi
else
    CLEANED_WIN_TITLE=${WINDOW_TITLE//$APP_TITLE | /}
    CLEANED_WIN_TITLE=${CLEANED_WIN_TITLE// | $APP_TITLE/}
    CLEANED_WIN_TITLE=${CLEANED_WIN_TITLE//$APP_TITLE - /}
    CLEANED_WIN_TITLE=${CLEANED_WIN_TITLE//$APP_TITLE – /}
    CLEANED_WIN_TITLE=${CLEANED_WIN_TITLE// – $APP_TITLE/}
    CLEANED_WIN_TITLE=${CLEANED_WIN_TITLE// - $APP_TITLE/}
    if [[ $APP_TITLE = $CLEANED_WIN_TITLE ]]; then
        TITLE="${APP_TITLE}"
    else
        TITLE="${APP_TITLE} | ${CLEANED_WIN_TITLE}"
    fi
fi
sketchybar -m --set window label="$TITLE"
'

sketchybar --add item window center
sketchybar --set window label.font="FiraCode Nerd Font Mono:Medium:12.0"
sketchybar --set window script="$TITLE_SCRIPT"
sketchybar --subscribe window yabai_window
$($TITLE_SCRIPT)

# ------- CPU Usage ----------
CPU_SCRIPT='
CORE_COUNT=$(sysctl -n machdep.cpu.thread_count)
CPU_INFO=$(ps -eo pcpu,user)
CPU_SYS=$(echo "$CPU_INFO" | sed "s/[^ 0-9\.]//g" | awk "{sum+=\$1} END {print sum/(100.0 * $CORE_COUNT)}")
CPU_USE=$(printf "%02.0f"\\n "$(echo "$CPU_SYS*100"  | bc -l)")
sketchybar --set cpu label="CPU: ${CPU_USE}%"
'

sketchybar --add item cpu left
sketchybar --set cpu label.font="FiraCode Nerd Font Mono:Medium:12.0"
sketchybar --set cpu script="$CPU_SCRIPT"
sketchybar --set cpu update_freq=2

# ------- RAM Usage ----------
RAM_SCRIPT='sketchybar -m --set ram label="RAM: $(memory_pressure | grep "System-wide memory free percentage:" | awk "{ print 100-\$5 }")%"'
sketchybar --add item ram left
sketchybar --set ram label.font="FiraCode Nerd Font Mono:Medium:12.0"
sketchybar --set ram label.padding_left=20
sketchybar --set ram script="$RAM_SCRIPT"
sketchybar --set ram update_freq=2

# ------- Weather ----------
sketchybar --add item weather right
sketchybar --set weather update_freq=600
sketchybar --set weather script="$HOME/.config/sketchybar/weather.sh" # Fix this
sketchybar --set weather icon.font="FiraCode Nerd Font Mono:Medium:22.0"
sketchybar --set weather label.font="FiraCode Nerd Font Mono:Medium:12.0"
sketchybar --set weather background.drawing=on
sketchybar --set weather label.padding_right=80
sketchybar --set weather label.padding_left=10
$($HOME/.config/sketchybar/weather.sh)

# ------- skhd Modal ----------
sketchybar --add item modal left
sketchybar --set modal icon=[n]
sketchybar --set modal icon.padding_left=80

# ------- Yabai Float ----------
sketchybar --add item yabai_float left
sketchybar --add event window_focus
sketchybar --add event float_change
sketchybar --set yabai_float label.padding_left=20
sketchybar --set yabai_float label.font="FiraCode Nerd Font Mono:Medium:24.0"
sketchybar --set yabai_float script="~/.config/sketchybar/yabai_float.sh"
sketchybar --subscribe yabai_float yabai_window
$($HOME/.config/sketchybar/yabai_float.sh)

# ------- Yabai Mode ----------
sketchybar --add item yabai_mode left
sketchybar --set yabai_mode update_freq=600
sketchybar --set yabai_mode label.padding_left=20
sketchybar --set yabai_mode label.font="FiraCode Nerd Font Mono:Medium:12.0"
sketchybar --set yabai_mode script="~/.config/sketchybar/yabai_mode.sh"
sketchybar --subscribe yabai_mode yabai_window
$($HOME/.config/sketchybar/yabai_mode.sh)
